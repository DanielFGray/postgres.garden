# Handoff: ts-28c663 (2026-02-16)

## Context
- Task: Offline-capable SSR fallback using cached initial data.
- Requirements: persist `window.__INITIAL_DATA__` to IndexedDB, hydrate from cache when offline, prefer local playground data, and revalidate session on reconnect.

## What was done
- Added `src/features/initialDataCache.ts` to cache SSR initial data in IndexedDB, merge with URL route, and revalidate `/api/me` on reconnect.
- Added `src/features/playground/localStore.ts` to cache playground commits (latest + commitId) in IndexedDB for offline loads.
- Added `src/features/initialDataEvents.ts` to propagate initial-data auth updates without global CustomEvent.
- Updated `src/features/workspaceSwitcher.ts` to read cached commits when offline and to write cached commits on load.
- Updated `src/features/auth.ts` to sync provider state from initial-data updates.
- Made InitialData types global in `src/types.d.ts` and loaded cache module early in `src/loader.ts`.
- User-scoped caches: store `userId` with cached data, skip mismatched cache entries, and clear caches on signout or user change.

## Verification
- `bun typecheck` (pass)
- `bun lint` (fails: `k6/*.js` not in tsconfig; tracked in ts-15b6a4)
- `bun run build` (pass; existing Sass/pglite warnings)
- First build attempt hit 120s timeout; re-ran with extended timeout.

## Key decisions
- Used internal event bus (`initialDataEvents`) instead of global CustomEvent to reduce spoofability.
- Cache scope tied to `userId` with explicit cache clears on signout/user change.

## Files touched
- `src/features/initialDataCache.ts`
- `src/features/playground/localStore.ts`
- `src/features/initialDataEvents.ts`
- `src/features/workspaceSwitcher.ts`
- `src/features/auth.ts`
- `src/loader.ts`
- `src/types.d.ts`

## Open issues / limitations
- Offline experience still depends on the last stored user data; if a user never logs out on a shared browser, cached data remains available offline.
